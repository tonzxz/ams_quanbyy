<!-- Main Card -->
<div class="w-full p-4">
  <p-card styleClass="shadow-lg">
    <div class="p-card-content">
      <!-- Header Section -->
      <div class="p-6">
      <div class="flex justify-between items-center mb-2">
        <h1 class="text-xl font-semibold text-gray-800">PPMP Management</h1>
        <p-button 
          label="Add PPMP" 
          icon="pi pi-plus"
          styleClass="p-button-primary"
          [outlined]="true"
          (click)="openNewPpmpDialog()">
        </p-button>
      </div>
      <p class="text-gray-600 text-sm mb-6">
        Manage Project Procurement Management Plan (PPMP)
      </p>

      <!-- Filter Section -->
    <div class="flex items-center gap-4 mb-6">
    <div class="flex items-center gap-3">
      <span class="text-sm">Fiscal Year:</span>
      <p-dropdown
        [options]="years"
        [(ngModel)]="selectedYear"
        (onChange)="filterByYear()"
        [placeholder]="'Select Year'"
        [showClear]="false"
        appendTo="body">
      </p-dropdown>
    </div>

    <button 
      pButton 
      label="Generate PDF"
      icon="pi pi-file-pdf"
      class="p-button-outlined">
    </button>
  </div>
      <!-- Table Section -->
       <p-table 
        [value]="filteredPpmps" 
        [rows]="10"
        [paginator]="true"
        [rowHover]="true"
        [showCurrentPageReport]="true"
        [loading]="loading"
        styleClass="p-datatable-sm">
        
        <ng-template pTemplate="header">
          <tr>
            <th>Project Code</th>
            <th>Project Title</th>
            <th>Classification</th>
            <th>Procurement Mode</th>
            <th>Total Cost</th>
            <th>Fiscal Year</th>
            <th style="width: 100px">Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-ppmp>
          <tr>
                        <td>{{ppmp.project?.project_code}}</td>

            <td>{{ppmp.project?.project_title}}</td>
            <td>
              <span class="px-2 py-1 rounded-full text-xs" 
                [ngClass]="getClassificationClass(ppmp.project?.classification)">
                {{ppmp.project?.classification | titlecase}}
              </span>
            </td>
            <td>{{getProcurementModeLabel(ppmp.project?.procurement_mode_id)}}</td>
            <td>₱{{ppmp.item?.estimated_total_cost | number:'1.2-2'}}</td>
            <td>{{ppmp.fiscal_year}}</td>
            <td>
              <div class="flex gap-2 justify-center">
                <button 
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-primary p-button-sm"
                  pTooltip="Edit PPMP"
                  [outlined]="true"
                  (click)="editPpmp(ppmp)">
                </button>
                <button 
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-danger p-button-sm"
                  pTooltip="Delete PPMP"
                  [outlined]="true"
                  (click)="deletePpmp(ppmp)">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center p-4">
              <div class="flex flex-col items-center justify-center text-gray-500">
                <i class="pi pi-folder-open text-3xl mb-2"></i>
                <span>No PPMP records found</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

<!-- PPMP Dialog -->
<p-dialog 
  [(visible)]="ppmpDialog" 
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  [style]="{width: '700px'}"
  styleClass="p-0"
  [header]="isEditMode ? 'Edit PPMP' : 'New PPMP'"
  >

  <form [formGroup]="ppmpForm" class="p-fluid">
    <!-- Project Information Section -->
    <div class="mb-6">
      <div class="bg-gray-50 p-3 rounded-lg mb-4">
        <h2 class="text-lg font-medium text-gray-800 mb-1">Project Information</h2>
        <p class="text-sm text-gray-600">Enter the basic project details and requirements</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4" formGroupName="project">
        <!-- Project Title -->
        <div class="col-span-2">
          <label for="project_title" class="text-sm font-medium text-gray-700 mb-1 block">
            Project Title <span class="text-red-500">*</span>
          </label>
          <input 
            pInputText 
            id="project_title"
            formControlName="project_title"
            [class.ng-invalid]="isFieldInvalid('project.project_title')"
            placeholder="Enter project title"
            class="w-full"/>
          <small class="text-red-500" *ngIf="isFieldInvalid('project.project_title')">
            Project title is required
          </small>
        </div>

        <!-- Project Code -->
        <div>
          <label for="project_code" class="text-sm font-medium text-gray-700 mb-1 block">
            Project Code
          </label>
          <input 
            pInputText 
            id="project_code"
            formControlName="project_code"
            placeholder="Enter project code"
            class="w-full"/>
        </div>

        <!-- Classification -->
        <div>
          <label for="classification" class="text-sm font-medium text-gray-700 mb-1 block">
            Classification <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="classification"
            [options]="classifications"
            formControlName="classification"
            [class.ng-invalid]="isFieldInvalid('project.classification')"
            placeholder="Select classification"
            styleClass="w-full"
            [autoDisplayFirst]="false">
          </p-dropdown>
          <small class="text-red-500" *ngIf="isFieldInvalid('project.classification')">
            Classification is required
          </small>
        </div>

        <!-- Procurement Mode -->
        <div>
          <label for="procurement_mode" class="text-sm font-medium text-gray-700 mb-1 block">
            Procurement Mode <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="procurement_mode"
            [options]="procurementModes"
            formControlName="procurement_mode_id"
            [class.ng-invalid]="isFieldInvalid('project.procurement_mode_id')"
            placeholder="Select procurement mode"
            styleClass="w-full"
            [autoDisplayFirst]="false">
          </p-dropdown>
          <small class="text-red-500" *ngIf="isFieldInvalid('project.procurement_mode_id')">
            Procurement mode is required
          </small>
        </div>

        <!-- Funding Source -->
        <div>
          <label for="funding_source" class="text-sm font-medium text-gray-700 mb-1 block">
            Funding Source <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="funding_source"
            [options]="fundingSources"
            formControlName="funding_source_id"
            [class.ng-invalid]="isFieldInvalid('project.funding_source_id')"
            placeholder="Select funding source"
            styleClass="w-full"
            [autoDisplayFirst]="false">
          </p-dropdown>
          <small class="text-red-500" *ngIf="isFieldInvalid('project.funding_source_id')">
            Funding source is required
          </small>
        </div>

        <!-- Project Description -->
        <div class="col-span-2">
          <label for="project_description" class="text-sm font-medium text-gray-700 mb-1 block">
            Project Description <span class="text-red-500">*</span>
          </label>
          <textarea 
            pInputTextarea 
            id="project_description"
            formControlName="project_description"
            [class.ng-invalid]="isFieldInvalid('project.project_description')"
          rows="5" cols="30" pTextarea
            placeholder="Enter project description"
            class="w-full">
          </textarea>
          <small class="text-red-500" *ngIf="isFieldInvalid('project.project_description')">
            Project description is required
          </small>
        </div>
      </div>
    </div>

    <!-- Item Information Section -->
    <div class="mb-6">
      <div class="bg-gray-50 p-3 rounded-lg mb-4">
        <h2 class="text-lg font-medium text-gray-800 mb-1">Item Information</h2>
        <p class="text-sm text-gray-600">Specify the item details and cost estimates</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4" formGroupName="item">
        <!-- Technical Specification -->
        <div class="col-span-2">
          <label for="technical_specification" class="text-sm font-medium text-gray-700 mb-1 block">
            Technical Specification <span class="text-red-500">*</span>
          </label>
          <textarea 
            pInputTextarea 
            id="technical_specification"
            formControlName="technical_specification"
            [class.ng-invalid]="isFieldInvalid('item.technical_specification')"
            rows="5" cols="30" pTextarea
            placeholder="Enter technical specifications"
            class="w-full">
          </textarea>
          <small class="text-red-500" *ngIf="isFieldInvalid('item.technical_specification')">
            Technical specification is required
          </small>
        </div>

        <!-- Unit of Measurement -->
        <div>
          <label for="unit_measurement" class="text-sm font-medium text-gray-700 mb-1 block">
            Unit of Measurement <span class="text-red-500">*</span>
          </label>
          <input 
            pInputText 
            id="unit_measurement"
            formControlName="unit_of_measurement"
            [class.ng-invalid]="isFieldInvalid('item.unit_of_measurement')"
            placeholder="e.g., pieces, lot"
            class="w-full"/>
          <small class="text-red-500" *ngIf="isFieldInvalid('item.unit_of_measurement')">
            Unit of measurement is required
          </small>
        </div>

        <!-- Quantity Required -->
        <div>
          <label for="quantity_required" class="text-sm font-medium text-gray-700 mb-1 block">
            Quantity Required <span class="text-red-500">*</span>
          </label>
          <p-inputNumber 
            id="quantity_required"
            formControlName="quantity_required"
            [showButtons]="true"
            [min]="1"
            [class.ng-invalid]="isFieldInvalid('item.quantity_required')"
            placeholder="Enter quantity"
            styleClass="w-full">
          </p-inputNumber>
          <small class="text-red-500" *ngIf="isFieldInvalid('item.quantity_required')">
            Quantity is required and must be greater than 0
          </small>
        </div>

        <!-- Estimated Unit Cost -->
        <div>
          <label for="estimated_unit_cost" class="text-sm font-medium text-gray-700 mb-1 block">
            Estimated Unit Cost <span class="text-red-500">*</span>
          </label>
          <p-inputNumber 
            id="estimated_unit_cost"
            formControlName="estimated_unit_cost"
            mode="currency" 
            currency="PHP"
            [min]="0"
            [class.ng-invalid]="isFieldInvalid('item.estimated_unit_cost')"
            placeholder="₱0.00"
            styleClass="w-full">
          </p-inputNumber>
          <small class="text-red-500" *ngIf="isFieldInvalid('item.estimated_unit_cost')">
            Unit cost is required and must be greater than 0
          </small>
        </div>

        <!-- Estimated Total Cost -->
        <div>
          <label for="estimated_total_cost" class="text-sm font-medium text-gray-700 mb-1 block">
            Estimated Total Cost
          </label>
          <p-inputNumber 
            id="estimated_total_cost"
            formControlName="estimated_total_cost"
            mode="currency" 
            currency="PHP"
            [readonly]="true"
            styleClass="w-full bg-gray-50">
          </p-inputNumber>
        </div>
      </div>
    </div>
  </form>

  <!-- Dialog Footer -->
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button 
        label="Cancel" 
        icon="pi pi-times" 
        (click)="hideDialog()" 
        styleClass="p-button-text">
      </p-button>
      <p-button 
        label="Save" 
        icon="pi pi-check" 
        (click)="savePpmp()"
        [loading]="loading">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Toast & Confirm Dialog -->
<p-toast position="top-right"></p-toast>
<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle"></p-confirmDialog>

