<mat-card class="cardWithShadow">
  <mat-card-content>
    <!-- Header Section -->
    <mat-card-title>Department Management</mat-card-title>
    <mat-card-subtitle class="text-sm text-gray-500">
      View and manage departments, buildings, and offices in this section.
    </mat-card-subtitle>

    <!-- Action Buttons and Search -->
    <div class="flex justify-between items-center mt-4">
      <div class="flex gap-2">
        <p-button
          pTooltip="Add Department"
          (click)="openNewDepartmentDialog()"
          [outlined]="true"
          size="small"
          label="Add Department"
          icon="pi pi-plus"
        ></p-button>
      </div>

      <div class="relative w-[300px]">
        <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
        <input
          pInputText
          type="text"
          #searchInput
          (input)="dt1.filterGlobal(searchInput.value, 'contains')"
          placeholder="Search Departments"
          style="text-indent: 1.5rem;"
          class="w-full border border-gray-300 rounded-md py-2 pl-10 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:ml-6"
        />
      </div>
    </div>

    <!-- Departments Table -->
    <p-table
      #dt1
      [value]="departments"
      [rows]="10"
      [paginator]="true"
      [globalFilterFields]="['name', 'code', 'head', 'contactEmail']"
      [rowsPerPageOptions]="[5, 10, 20]"
      [loading]="loading"
      [showCurrentPageReport]="false"
      [responsive]="true"
      [rowHover]="true"
      [scrollable]="true"
      scrollHeight="600px"
      styleClass="p-datatable-sm"
      [tableStyle]="{'min-width': '60rem'}"
      dataKey="id"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="name">Name <p-sortIcon field="name"></p-sortIcon></th>
          <th pSortableColumn="code">Code <p-sortIcon field="code"></p-sortIcon></th>
          <th pSortableColumn="head">Head <p-sortIcon field="head"></p-sortIcon></th>
          <th pSortableColumn="contactEmail">Email <p-sortIcon field="contactEmail"></p-sortIcon></th>
          <th>Buildings</th>
          <th>Offices</th>
          <th class="w-[150px]">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-department>
        <tr>
          <td>{{ department.name }}</td>
          <td>{{ department.code }}</td>
          <td>{{ department.head }}</td>
          <td>{{ department.contactEmail }}</td>
          <td>{{ getBuildingCount(department) }}</td>
          <td>{{ getOfficeCount(department) }}</td>
          <td>
            <div class="flex gap-2">
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-rounded p-button-primary p-button-sm"
                [outlined]="true"
                pTooltip="Edit Department"
                (click)="editDepartment(department)"
              ></button>
              <button
                pButton
                icon="pi pi-building"
                class="p-button-rounded p-button-success p-button-sm"
                [outlined]="true"
                pTooltip="Manage Buildings"
                (click)="manageBuildings(department)"
              ></button>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-rounded p-button-danger p-button-sm"
                [outlined]="true"
                pTooltip="Delete Department"
                (click)="deleteDepartment(department)"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7">
            <div class="flex flex-col w-full items-center justify-center py-8">
              <span>No departments found.</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Department Dialog -->
    <p-dialog
      [(visible)]="departmentDialog"
      [modal]="true"
      [style]="{ width: '90vw', maxWidth: '450px' }"
      [header]="isEditMode ? 'Edit Department' : 'Add New Department'"
      styleClass="p-fluid"
      [dismissableMask]="true"
      [draggable]="false"
      [resizable]="false"
      [position]="'center'"
    >
      <form [formGroup]="departmentForm" class="w-full">
        <!-- Department Name -->
        <div class="field mb-4">
          <label for="name">Name*</label>
          <input 
            type="text" 
            pInputText 
            id="name" 
            formControlName="name" 
            [ngClass]="{'ng-invalid ng-dirty': submitted && departmentForm.get('name')?.errors}"
            autofocus />
          <small class="p-error" *ngIf="submitted && departmentForm.get('name')?.errors?.['required']">Name is required.</small>
        </div>

        <!-- Department Code -->
        <div class="field mb-4">
          <label for="code">Code*</label>
          <input 
            type="text" 
            pInputText 
            id="code" 
            formControlName="code" 
            [ngClass]="{'ng-invalid ng-dirty': submitted && departmentForm.get('code')?.errors}" />
          <small class="p-error" *ngIf="submitted && departmentForm.get('code')?.errors?.['required']">Code is required.</small>
        </div>

        <!-- Head -->
        <div class="field mb-4">
          <label for="head">Department Head*</label>
          <input 
            type="text" 
            pInputText 
            id="head" 
            formControlName="head" 
            [ngClass]="{'ng-invalid ng-dirty': submitted && departmentForm.get('head')?.errors}" />
          <small class="p-error" *ngIf="submitted && departmentForm.get('head')?.errors?.['required']">Department head is required.</small>
        </div>

        <!-- Email -->
        <div class="field mb-4">
          <label for="email">Email*</label>
          <input 
            type="email" 
            pInputText 
            id="email" 
            formControlName="contactEmail" 
            [ngClass]="{'ng-invalid ng-dirty': submitted && departmentForm.get('contactEmail')?.errors}" />
          <small class="p-error" *ngIf="submitted && departmentForm.get('contactEmail')?.errors?.['required']">Email is required.</small>
          <small class="p-error" *ngIf="submitted && departmentForm.get('contactEmail')?.errors?.['email']">Invalid email format.</small>
        </div>

        <!-- Phone -->
        <div class="field mb-4">
          <label for="phone">Phone*</label>
          <input 
            type="text" 
            pInputText 
            id="phone" 
            formControlName="contactPhone" 
            [ngClass]="{'ng-invalid ng-dirty': submitted && departmentForm.get('contactPhone')?.errors}" />
          <small class="p-error" *ngIf="submitted && departmentForm.get('contactPhone')?.errors?.['required']">Phone is required.</small>
        </div>

        <!-- Budget -->
        <div class="field mb-4">
          <label for="budget">Budget*</label>
          <input 
            type="number" 
            pInputText 
            id="budget" 
            formControlName="budget" 
            [ngClass]="{'ng-invalid ng-dirty': submitted && departmentForm.get('budget')?.errors}" />
          <small class="p-error" *ngIf="submitted && departmentForm.get('budget')?.errors?.['required']">Budget is required.</small>
        </div>

        <!-- Description -->
        <div class="field mb-4">
          <label for="description">Description</label>
          <textarea 
            pInputTextarea 
            id="description" 
            formControlName="description" 
            rows="3"></textarea>
        </div>
      </form>

      <ng-template pTemplate="footer">
        <button 
          pButton 
          label="Cancel" 
          icon="pi pi-times" 
          class="p-button-text" 
          (click)="hideDialog()"></button>
        <button 
          pButton 
          label="Save" 
          icon="pi pi-check" 
          class="p-button-primary" 
          (click)="saveDepartment()"></button>
      </ng-template>
    </p-dialog>

    <!-- Buildings Dialog -->
    <p-dialog
      [(visible)]="buildingDialog"
      [modal]="true"
      [style]="{ width: '90vw', maxWidth: '800px' }"
      [header]="'Manage Buildings - ' + (selectedDepartment?.name || '')"
      styleClass="p-fluid"
      [dismissableMask]="true"
      [draggable]="false"
      [resizable]="false"
      [position]="'center'"
    >
      <div class="mb-4">
        <button 
          pButton 
          label="Add Building" 
          icon="pi pi-plus" 
          class="p-button-success" 
          (click)="openNewBuildingDialog()"></button>
      </div>

      <p-table 
        [value]="selectedDepartment?.buildings || []" 
        [responsive]="true" 
        styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Address</th>
            <th>Floors</th>
            <th>Offices</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-building>
          <tr>
            <td>{{building.name}}</td>
            <td>{{building.address}}</td>
            <td>{{building.numberOfFloors}}</td>
            <td>{{building.offices?.length || 0}}</td>
            <td>
              <div class="flex gap-2">
                <button 
                  pButton 
                  icon="pi pi-pencil" 
                  class="p-button-rounded p-button-primary p-button-sm" 
                  [outlined]="true"
                  (click)="editBuilding(building)"></button>
                <button 
                  pButton 
                  icon="pi pi-home" 
                  class="p-button-rounded p-button-success p-button-sm" 
                  [outlined]="true"
                  (click)="manageOffices(building)"></button>
                <button 
                  pButton 
                  icon="pi pi-trash" 
                  class="p-button-rounded p-button-danger p-button-sm" 
                  [outlined]="true"
                  (click)="deleteBuilding(selectedDepartment?.id, building.id)"></button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">No buildings found.</td>
          </tr>
        </ng-template>
      </p-table>

      <div *ngIf="currentBuilding" [formGroup]="buildingForm" class="mt-4">
       <form *ngIf="buildingForm" [formGroup]="buildingForm" class="w-full">
  <div class="field mb-4">
    <label for="buildingName">Name*</label>
    <input pInputText id="buildingName" formControlName="name" class="w-full"/>
    <small class="p-error" *ngIf="buildingSubmitted && buildingForm.get('name')?.errors?.['required']">
      Building name is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="address">Address*</label>
    <input pInputText id="address" formControlName="address" class="w-full"/>
    <small class="p-error" *ngIf="buildingSubmitted && buildingForm.get('address')?.errors?.['required']">
      Address is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="floors">Number of Floors*</label>
    <input pInputText type="number" id="floors" formControlName="numberOfFloors" class="w-full"/>
    <small class="p-error" *ngIf="buildingSubmitted && buildingForm.get('numberOfFloors')?.errors?.['required']">
      Number of floors is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="buildingNotes">Notes</label>
    <textarea pInputTextarea id="buildingNotes" formControlName="notes" rows="3" class="w-full"></textarea>
  </div>

  <div class="flex justify-end gap-2">
    <button pButton label="Save Building" icon="pi pi-check" class="p-button-primary" (click)="saveBuilding()"></button>
  </div>
</form>
      </div>
    </p-dialog>

    <!-- Offices Dialog -->
    <p-dialog
      [(visible)]="officeDialog"
      [modal]="true"
      [style]="{ width: '90vw', maxWidth: '800px' }"
      [header]="'Manage Offices - ' + (selectedBuilding?.name || '')"
      styleClass="p-fluid"
      [dismissableMask]="true"
      [draggable]="false"
      [resizable]="false"
      [position]="'center'"
    >
      <div class="mb-4">
        <button 
          pButton 
          label="Add Office" 
          icon="pi pi-plus" 
          class="p-button-success" 
          (click)="openNewOfficeDialog()"></button>
      </div>

      <p-table 
        [value]="selectedBuilding?.offices || []" 
        [responsive]="true" 
        styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Room Number</th>
            <th>Floor</th>
            <th>Capacity</th>
            <th>Extension</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-office>
          <tr>
            <td>{{office.name}}</td>
            <td>{{office.roomNumber}}</td>
            <td>{{office.floor}}</td>
            <td>{{office.capacity}}</td>
            <td>{{office.extension}}</td>
            <td>
              <div class="flex gap-2">
                <button 
                  pButton 
                  icon="pi pi-pencil" 
                  class="p-button-rounded p-button-primary p-button-sm" 
                  [outlined]="true"
                  (click)="editOffice(office)"></button>
                <button 
                  pButton 
                  icon="pi pi-trash" 
                  class="p-button-rounded p-button-danger p-button-sm" 
                  [outlined]="true"
                  (click)="deleteOffice(selectedDepartment?.id, selectedBuilding?.id, office.id)"></button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6">No offices found.</td>
          </tr>
        </ng-template>
      </p-table>

      <div *ngIf="currentOffice" class="mt-4">
       <form *ngIf="officeForm" [formGroup]="officeForm" class="w-full">
  <div class="field mb-4">
    <label for="officeName">Name*</label>
    <input pInputText id="officeName" formControlName="name" class="w-full"/>
    <small class="p-error" *ngIf="officeSubmitted && officeForm.get('name')?.errors?.['required']">
      Office name is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="roomNumber">Room Number*</label>
    <input pInputText id="roomNumber" formControlName="roomNumber" class="w-full"/>
    <small class="p-error" *ngIf="officeSubmitted && officeForm.get('roomNumber')?.errors?.['required']">
      Room number is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="floor">Floor*</label>
    <input pInputText type="number" id="floor" formControlName="floor" class="w-full"/>
    <small class="p-error" *ngIf="officeSubmitted && officeForm.get('floor')?.errors?.['required']">
      Floor number is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="capacity">Capacity*</label>
    <input pInputText type="number" id="capacity" formControlName="capacity" class="w-full"/>
    <small class="p-error" *ngIf="officeSubmitted && officeForm.get('capacity')?.errors?.['required']">
      Capacity is required.
    </small>
  </div>

  <div class="field mb-4">
    <label for="extension">Extension</label>
    <input pInputText id="extension" formControlName="extension" class="w-full"/>
  </div>

  <div class="field mb-4">
    <label for="officeNotes">Notes</label>
    <textarea pInputTextarea id="officeNotes" formControlName="notes" rows="3" class="w-full"></textarea>
  </div>

  <div class="flex justify-end gap-2">
    <button pButton label="Save Office" icon="pi pi-check" class="p-button-primary" (click)="saveOffice()"></button>
  </div>
</form>
      </div>
    </p-dialog>

    <!-- Confirmation Dialog -->
    <p-confirmDialog 
      header="Confirmation" 
      icon="pi pi-exclamation-triangle"
      [style]="{width: '450px'}"
      acceptButtonStyleClass="p-button-danger"
      rejectButtonStyleClass="p-button-text"
      acceptLabel="Delete"
      rejectLabel="Cancel">
    </p-confirmDialog>
  </mat-card-content>
</mat-card>